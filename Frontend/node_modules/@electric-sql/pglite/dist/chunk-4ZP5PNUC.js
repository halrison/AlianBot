import{a as O,b as D,c as Q,d as z,f as R,g as B,i as c}from"./chunk-JSQ47LU7.js";import{d as g}from"./chunk-PZ27VTCT.js";import{d as w,e as P,f as p,g as t,i as E}from"./chunk-MPW3RCU6.js";E();var b,u,r,o,d,h,f,v=class{constructor(){P(this,r);this.serializers={...D};this.parsers={...O};P(this,b,!1);P(this,u,!1)}async _initArrayTypes(){if(w(this,b))return;p(this,b,!0);let a=await this.query(`
      SELECT b.oid, b.typarray
      FROM pg_catalog.pg_type a
      LEFT JOIN pg_catalog.pg_type b ON b.oid = a.typelem
      WHERE a.typcategory = 'A'
      GROUP BY b.oid, b.typarray
      ORDER BY b.oid
    `);for(let s of a.rows)this.serializers[s.typarray]=e=>Q(e,this.serializers[s.oid],s.typarray),this.parsers[s.typarray]=e=>z(e,this.parsers[s.oid],s.typarray)}async query(a,s,e){return await this._checkReady(),await this._runExclusiveTransaction(async()=>await t(this,r,d).call(this,a,s,e))}async sql(a,...s){let{query:e,params:l}=g(a,...s);return await this.query(e,l)}async exec(a,s){return await this._checkReady(),await this._runExclusiveTransaction(async()=>await t(this,r,h).call(this,a,s))}async describeQuery(a,s){try{await t(this,r,o).call(this,c.parse({text:a,types:s?.paramTypes}),s);let e=await t(this,r,o).call(this,c.describe({type:"S"}),s),l=e.messages.find(i=>i.name==="parameterDescription"),n=e.messages.find(i=>i.name==="rowDescription"),y=l?.dataTypeIDs.map(i=>({dataTypeID:i,serializer:this.serializers[i]}))??[],m=n?.fields.map(i=>({name:i.name,dataTypeID:i.dataTypeID,parser:this.parsers[i.dataTypeID]}))??[];return{queryParams:y,resultFields:m}}finally{await t(this,r,o).call(this,c.sync(),s)}}async transaction(a){return await this._checkReady(),await this._runExclusiveTransaction(async()=>{await t(this,r,h).call(this,"BEGIN"),p(this,u,!0);let s=!1,e=()=>{if(s)throw new Error("Transaction is closed")},l={query:async(n,y,m)=>(e(),await t(this,r,d).call(this,n,y,m)),sql:async(n,...y)=>{let{query:m,params:i}=g(n,...y);return await t(this,r,d).call(this,m,i)},exec:async(n,y)=>(e(),await t(this,r,h).call(this,n,y)),rollback:async()=>{e(),await t(this,r,h).call(this,"ROLLBACK"),s=!0},get closed(){return s}};try{let n=await a(l);return s||(s=!0,await t(this,r,h).call(this,"COMMIT")),p(this,u,!1),n}catch(n){throw s||await t(this,r,h).call(this,"ROLLBACK"),p(this,u,!1),n}})}};b=new WeakMap,u=new WeakMap,r=new WeakSet,o=async function(a,s={}){return await this.execProtocol(a,{...s,syncToFs:!1})},d=async function(a,s=[],e){return await this._runExclusiveQuery(async()=>{t(this,r,f).call(this,"runQuery",a,s,e),await this._handleBlob(e?.blob);let l;try{let{messages:y}=await t(this,r,o).call(this,c.parse({text:a,types:e?.paramTypes}),e),m=B((await t(this,r,o).call(this,c.describe({type:"S"}),e)).messages),i=s.map((T,A)=>{let x=m[A];if(T==null)return null;let _=e?.serializers?.[x]??this.serializers[x];return _?_(T):T.toString()});l=[...y,...(await t(this,r,o).call(this,c.bind({values:i}),e)).messages,...(await t(this,r,o).call(this,c.describe({type:"P"}),e)).messages,...(await t(this,r,o).call(this,c.execute({}),e)).messages]}finally{await t(this,r,o).call(this,c.sync(),e)}await this._cleanupBlob(),w(this,u)||await this.syncToFs();let n=await this._getWrittenBlob();return R(l,this.parsers,e,n)[0]})},h=async function(a,s){return await this._runExclusiveQuery(async()=>{t(this,r,f).call(this,"runExec",a,s),await this._handleBlob(s?.blob);let e;try{e=(await t(this,r,o).call(this,c.query(a),s)).messages}finally{await t(this,r,o).call(this,c.sync(),s)}this._cleanupBlob(),w(this,u)||await this.syncToFs();let l=await this._getWrittenBlob();return R(e,this.parsers,s,l)})},f=function(...a){this.debug>0&&console.log(...a)};export{v as a};
//# sourceMappingURL=chunk-4ZP5PNUC.js.map